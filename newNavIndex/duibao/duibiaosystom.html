
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>京能集团实时技术监督生产管理系统</title>

    <link rel="stylesheet" href="../../common/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/pagination.css">
    <link rel="stylesheet" href="../css/bootstrap-datetimepicker.min.css">
    <link type="text/css" rel="stylesheet" href="css/news.css"/>
    <script src="../../common/js/jquery.min.js"></script>
<body>
<div class="wu_top">
    <div class="fengge"></div>
</div>

<div class="" style="margin-top: 0px;height:900px;">
    <div class="wu_main1">
        <div class="select " style="">
            <form class="form-inline">
                  
                    <button id="tj" class="form-control col-sm-1 btn btn-default jt" type="button" style="margin: 3px 5px 0 10px " data-toggle="modal" data-target="#myModal">提交流程</button>
                    <button class="form-control col-sm-1 btn btn-default" type="button" id="reCallProcess" style="margin: 3px 5px 0 ">撤回</button> 
                    <button class="form-control col-sm-1 btn btn-default" type="button" id="checkProcess" style="margin: 3px 5px 0 ">流程监控</button>  
                    <div class="form-group"  style="margin-left:30px;margin-right:50px;float:right;">
                        <button class ="form-control col-sm-1 btn btn-primary" type="button"  style="" id='query'>查询</button>
                    </div>
                    <div class="form-group" style="float:right;">
                        <label for="startTime" class=" control-label left"style="margin-left:100px;">时间查询</label>
                        <div class="input-group date form_datetime col-sm-2" data-link-field="dtp_input1" style="position: relative;top: -3px;">
                            <input class="form-control col-sm-12" size="16" type="text" value="" readonly="" style="width:150px" id="startTime">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                            <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                        </div>

                        <input type="hidden" id="dtp_input1" value=""><br>
                    </div>
                    
            </form>
        </div>
        <table class="wu_tab1 level4" >
            <thead>
                <tr>
                    <td style="max-width:3%;"></td>
                    <td style="max-width:3%;">序号</td>
                    <td style="max-width:30%;">编号</td>
                    <td style="max-width:10%;">季度</td>
                    <td style="max-width:30%;">描述</td>
                    <td style="max-width:5.5%;">单位</td>
                    <td style="max-width:5%;">流程状态</td>
                    <td style="max-width:5%;display:none;">创建时间</td>
                </tr>
            </thead>
            <tbody id="detail">             
            </tbody>
        </table>
        
           
        <!--<div id="Pagination" class="pagination" style="float:right"><!-- 这里显示分页 </div> -->
         <div class="fengge" style="clear:both"></div>  
    </div>

    <div class="fengge"></div>
    
</div>

<script>
    $(document).ready(function(){
        //使用datetimepicker
        $('.form_datetime').datetimepicker({
            format: 'yyyy',  
            weekStart: 1,  
            autoclose: true,  
            startView: 4,  
            minView: 4,  
            forceParse: false,  
            language: 'zh-CN'  
        });
    })
</script>
<script type="text/javascript" src="../../common/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/bootstrap-datetimepicker.min.js"></script>

<script type="text/javascript" src="js/jquery.pagination.js"></script>
<script src=  "../../webbuilder/controls/ext/ext-all.js" type="text/javascript" ></script>
<script src=  "../../webbuilder/controls/ext/locale/ext-lang-zh_CN.js" type="text/javascript" ></script>
<link href=   "../../webbuilder/controls/ext/resources/css/ext-all.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="js/duibiaosys.js"></script>
<script type="text/javascript">
/*对标流程相关*/
$(document).ready(function() {
	
	$("#tj").click(function() {
		//限制提交的条件 1.状态为待提交的2.撤回的 3.驳回的
		var checkedBox = $("input[type='radio']:checked");
		var length = checkedBox.length;
		if(length!=1)
		{
			alert('请选择一行');
			return ;
		}
		var status   = checkedBox.attr("data-status");
		if(status!='A'&&status!='R'&&status!='D'&&status!='F'&&status!='H'&&status!='G'){
			Ext.MessageBox.alert('提示','只有未提交、撤回、驳回状态才可以提交流程');
			return ;
		}
		var applyCode = checkedBox.parent().siblings().eq(1).html();
		var applyName = checkedBox.parent().siblings().eq(3).text();
		var orgId     = checkedBox.attr("data-org");
		var applyId   = checkedBox.val();
		console.log(applyCode);
		console.log(applyName);
		console.log(orgId);
		console.log(applyId);
		var json={applyCode:applyCode,applyName:applyName,orgId:orgId,applyId:applyId};
		console.log(json);
		startAndSubmitByEntityCode(
				'DUIBIAOGUANLI',
				json,
				function(e) {
					console.log(e);
					if(e.flag !=0)
					{
						console.log(e);
						Ext.Msg.alert('提示','流程提交失败!')
						return ;
					}
					var instCode = e.instanceCode;
					Ext.Ajax.request({
		                url:window.location.origin+"/jsjd/benchmark/addInstCode.do",
		                headers: {
		                    'userHeader': 'userMsg'
		                },
		                params: {applyId:applyId,instCode: instCode },
		                method: 'POST',
		                success: function (response, options) {
		                    Ext.MessageBox.alert('成功',"流程提交成功");
		                    $("#query").click();
		                },
		                failure: function (response, options) {
		                    Ext.MessageBox.alert('失败', '流程编码更新失败');
		                }
		            });
		});
	});
	//查看流程
	$("#checkProcess").click(function() {
		var checkedBox = $("input[type='radio']:checked");
		var length = checkedBox.length;
		if(length!=1)
		{
			alert('请选择一行');
			return ;
		}
		var status   = checkedBox.attr("data-status");
		if(status=='A'){
			Ext.MessageBox.alert('提示','流程未提交无法查看流程');
			return ;
		}
		var instCode   = checkedBox.attr("data-instcode");
		console.log(instCode);
		showMonitorPage(instCode);
	});
	//撤销流程
	$("#reCallProcess").click(function() {
		
		var checkedBox = $("input[type='radio']:checked");
		var length = checkedBox.length;
		if(length!=1)
		{
			Ext.MessageBox.alert('提示','请选择一行');
			return ;
		}
		//状态不为A可以撤销提交
		var instCode   = checkedBox.attr("data-instcode");
		var status   = checkedBox.attr("data-status");
		console.log('status='+status);
		if(status=='A'||status=='R'||status=='F'||status=='D'||status=='G'||status=='H')
		{
			Ext.MessageBox.alert('提示','未提交、撤销、驳回的流程不可以撤销');
			return;
		}
    	revokeByInstanceCode(instCode,function(e){
        	//Ext.Msg.alert('提示',e.msg);
        	console.log(e);
        	if(e.flag==1)
        	{
        		Ext.MessageBox.alert('撤销失败',e.msg);
        		return ;
        	}
        	//修改业务表里的状态
        	Ext.Ajax.request({
                url:window.location.origin+"/jsjd/benchmark/revokeProcessByInstCode.do",
                headers: {
                    'userHeader': 'userMsg'
                },
                params: {instCode: instCode },
                method: 'POST',
                success: function (response, options) {
                    Ext.MessageBox.alert('成功',"流程撤消成功");
                    $("#query").click();
                },
                failure: function (response, options) {
                    Ext.MessageBox.alert('失败', '流程状态电厂更新更新失败');
                    $("#query").click();
                }
            });
      	});
	});
	
	
	
});

</script>
<script type="text/javascript" src="../kaohe/js/SimpleTree.js"></script>
</body>
<script type="text/javascript" src="../kaohe/js/workflowUtil4.0.js"></script></html>
<script type="text/javascript" src="../kaohe/js/Sweefty.js"></script>
<script type="text/javascript" src="../kaohe/js/moaModal.minified.js"></script>